language: c
sudo: false

matrix:
  include:
    - compiler: gcc
      env: CODECOV='1.6.3'
    - compiler: gcc
      env: COMPILER='gcc-5'
    - compiler: gcc
      env: COMPILER='i686-w64-mingw32-gcc'
    - compiler: gcc
      env: COMPILER='x86_64-w64-mingw32-gcc'
    - compiler: clang

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - gcc-5
      - gcc-mingw-w64-i686
      - binutils-mingw-w64-i686
      - gcc-mingw-w64-x86-64
      - binutils-mingw-w64-x86-64

install:
  - if [ "$CC" = 'clang' ]; then
      export CC=`which clang`;
    fi
  - if [ -n "$CODECOV" ]; then
      pip install --user codecov;
    fi

before_script:
  - make PREFIX=~ bootstrap
  - export MILKYC=~/bin/milky
  - if [ -n "$COMPILER" ]; then
      export CC="$COMPILER";
      $CC --version;
    fi

script:
  - if [[ "$CC" =~ 'mingw' ]]; then
      make TARGET=milky-${CC}.exe release;
    else
      make test;
    fi

after_success:
  - if [ -n "$CODECOV" ]; then
      make clean;
      make coverage;
      bin/milky src/*.k;
      make dummy;
      rm -rf src;
      mv obj/src ./;
      wget "https://github.com/codecov/codecov-python/archive/v${CODECOV}.tar.gz";
      tar -xzvf v${CODECOV}.tar.gz;
      export CODECOV=codecov-python-${CODECOV}/codecov/__init__.py;
      sed -i "s:\(write('==> \)\(Upload\)\(ing')\):\1Overwrit\3;\
        reports = re.sub('(src[#/]'\
        '\\\\\\\\\w+\\\\\\\\.c)(?\!\\\\\\\\.k)', '\\\\\\\\1.k', \
        reports);\1\2\3:" ${CODECOV};
      python ${CODECOV} --gcov-args '-o obj';
    fi
  - make distclean
